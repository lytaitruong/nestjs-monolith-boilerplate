name: Build to ECR

on:
  push:
    branches:
    - development
    - uat
    - production

env:
  ECR_REPOSITORY: nestjs-monolith-boilerplate
  ECR_ENVIRONMENT: ${{ github.head_ref || github.ref_name }}

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout

jobs:
  defined-metadata:
    name: Metadata
    runs-on: self-hosted
    outputs:
      repository-name: ${{ steps.defined-env.outputs.repository-name }}
    steps:
    - name: Set Environment
      id: defined-env
      run: |
        echo "repository-name=${{ env.ECR_REPOSITORY }}-${{ env.ECR_ENVIRONMENT }}" >> "$GITHUB_OUTPUT"

  build-image:
    needs: [defined-metadata]
    name: Build & Push Image to ECR
    uses: ./.github/workflows/call-build.yml
    with:
      repository-name: ${{ needs.defined-metadata.outputs.repository-name }}
    secrets:
      AWS_IAM_ROLE_ASSUME: ${{ secrets.AWS_IAM_ROLE_ASSUME }}
